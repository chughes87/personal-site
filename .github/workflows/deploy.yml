name: Deploy to S3

on:
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate HTML
        run: npx --yes html-validate index.html chat.html voice.html

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Inject API URL into chat.html
        env:
          CHAT_API_URL: ${{ secrets.CHAT_API_URL }}
        run: |
          if [ -n "$CHAT_API_URL" ]; then
            sed -i "s|https://TODO.execute-api.us-west-2.amazonaws.com|$CHAT_API_URL|" chat.html
          fi

      - name: Inject API URL into voice.html
        env:
          CHAT_API_URL: ${{ secrets.CHAT_API_URL }}
        run: |
          if [ -n "$CHAT_API_URL" ]; then
            sed -i "s|https://TODO.execute-api.us-west-2.amazonaws.com|$CHAT_API_URL|" voice.html
          fi

      # HTML files must never be served stale
      - name: Upload HTML (no-cache)
        run: |
          for f in *.html; do
            [ -f "$f" ] || continue
            aws s3 cp "$f" "s3://pointfree.space/$f" \
              --cache-control "no-cache, max-age=0" \
              --content-type "text/html; charset=utf-8"
          done

      # CSS/JS — short TTL (no content-hash filenames, so keep low)
      - name: Upload CSS and JS (5 min cache)
        run: |
          for f in src/*.css; do
            [ -f "$f" ] || continue
            aws s3 cp "$f" "s3://pointfree.space/$f" \
              --cache-control "public, max-age=300" \
              --content-type "text/css"
          done
          for f in src/*.js; do
            [ -f "$f" ] || continue
            aws s3 cp "$f" "s3://pointfree.space/$f" \
              --cache-control "public, max-age=300" \
              --content-type "application/javascript"
          done

      # Other static assets (images, fonts) — longer cache
      - name: Sync remaining assets (1 day cache)
        run: |
          aws s3 sync . s3://pointfree.space \
            --exclude "*" \
            --include "*.png" --include "*.jpg" --include "*.jpeg" \
            --include "*.webp" --include "*.svg" --include "*.ico" \
            --include "*.woff" --include "*.woff2" \
            --cache-control "public, max-age=86400"

      # Remove files deleted from the repo
      - name: Remove stale files from S3
        run: |
          aws s3 sync . s3://pointfree.space \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "api/*" \
            --exclude "PLAN.md" \
            --exclude "README.md" \
            --delete \
            --size-only

      # Invalidate CloudFront so the new files are served immediately.
      # Only runs once CLOUDFRONT_DISTRIBUTION_ID secret is set (after deploy-cdn.yml is run).
      - name: Invalidate CloudFront cache
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          if [ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation \
              --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
              --paths "/*"
          fi
